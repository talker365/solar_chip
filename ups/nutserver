#!/bin/bash

sudo apt-get install -y \
nut-client nut-server \
usbutils

count=0
filename="/etc/nut/ups.conf"
sudo mv $filename $filename.orig
printf "# Generated by VDN Script \n\n" > $filename
lsusb | grep -v "inux" | grep -v "hub" | grep -v "HUB" | awk  ' { print $2,$4, $6, $7, $8, $9, $10, $11 $12} ' > /tmp/ups

 while read busId devId venId d1 d2 d3 d4 d5 d6; do

devId=${devId:0:3} # Strip off the :
venId=${venId:0:4} # Strip off before the :
upsId="[ups$count]"

printf "$upsId\n" >> $filename 
printf "\tdriver = usbhid-ups\n" >> $filename 
printf "\tport = auto\n" >> $filename
printf "\tdesc = \" $d1 $d2 $d3 $d4 $d5 $d6 \"\n" >> $filename
printf "\tvendorid = $venId\n\n\n" >> $filename

chmod 0666 /dev/bus/usb/$busId/$devId
((count ++))

done </tmp/ups

chmod 0755 $filename
rm /tmp/ups

filename="/etc/nut/upsd.conf"
port="3493"
sudo mv $filename $filename.orig

printf "# Generated by VDN Script \n\n" > $filename
printf "LISTEN 127.0.0.1 $port\n" >> $filename
printf "LISTEN $(ifconfig wlan1 | grep addr: | cut -d ":" -f2 | cut -d " " -f1) $port\n" >> $filename
chmod 0755 $filename

filename="/etc/nut/nut.conf"
sudo mv $filename $filename.orig
printf "# Generated by VDN Script \n\n" > $filename
printf "MODE=netserver\n" >> $filename
chmod 0755 $filename

# Start the ups driver
sudo upsdrvctl start



